# .github/workflows/notify-teams.yml
#
# DISABLED â€” No one reads the Teams posts. Kept for reference.
#
# Sends a Microsoft Teams notification when a new release is published.
# The message links to the EliteCAD Tools website (not GitHub).
#
# SETUP:
#   1. In Teams: Channel > Manage Channel > Connectors (or Workflows app)
#      â†’ Add "Incoming Webhook" â†’ Name it "EliteCAD Releases" â†’ Copy the URL
#   2. In GitHub: Repo Settings > Secrets > Actions
#      â†’ New secret: TEAMS_WEBHOOK_URL = <paste the webhook URL>

name: Notify Teams on Release (DISABLED)

# on:
#   release:
#     types: [published]
on: workflow_dispatch

jobs:
  notify-teams:
    runs-on: ubuntu-latest
    steps:
      - name: Parse release info
        id: info
        env:
          RELEASE_BODY: ${{ github.event.release.body }}
          RELEASE_NAME: ${{ github.event.release.name }}
          TAG: ${{ github.event.release.tag_name }}
        run: |
          # Tags follow pattern: EliteScan-latest, EliteDraft-latest, etc.
          ADDIN_NAME=$(echo "$TAG" | sed 's/-latest//')
          echo "addin=$ADDIN_NAME" >> "$GITHUB_OUTPUT"

          # Extract version from release name (e.g., "EliteScan v1.2.4")
          VERSION=$(echo "$RELEASE_NAME" | grep -oP 'v[\d.]+' || echo "")
          echo "version=$VERSION" >> "$GITHUB_OUTPUT"

          # Extract just the bullet points from "What's New" section.
          # Grabs lines starting with "- " between "What's New" and the next "###" heading.
          # Falls back to all bullet lines if no "What's New" section exists.
          NOTES=$(echo "$RELEASE_BODY" \
            | sed -n "/What's New/,/^###/{/^- /p}" \
            | sed 's/^- /â€¢ /' \
            | head -20)
          if [ -z "$NOTES" ]; then
            NOTES=$(echo "$RELEASE_BODY" | grep '^- ' | sed 's/^- /â€¢ /' | head -20)
          fi
          if [ -z "$NOTES" ]; then
            NOTES="See release notes for details."
          fi

          # Store multiline output safely
          {
            echo "notes<<NOTESEOF"
            echo "$NOTES"
            echo "NOTESEOF"
          } >> "$GITHUB_OUTPUT"

      - name: Send Teams notification
        env:
          ADDIN: ${{ steps.info.outputs.addin }}
          VERSION: ${{ steps.info.outputs.version }}
          NOTES: ${{ steps.info.outputs.notes }}
          AUTHOR: ${{ github.actor }}
          WEBHOOK_URL: ${{ secrets.TEAMS_WEBHOOK_URL }}
        run: |
          # Build the payload with jq (safe JSON encoding, no sed hacks)
          jq -n \
            --arg addin "$ADDIN" \
            --arg version "$VERSION" \
            --arg author "$AUTHOR" \
            --arg notes "$NOTES" \
          '{
            type: "message",
            attachments: [{
              contentType: "application/vnd.microsoft.card.adaptive",
              content: {
                "$schema": "http://adaptivecards.io/schemas/adaptive-card.json",
                type: "AdaptiveCard",
                version: "1.4",
                body: [
                  {
                    type: "Container",
                    style: "emphasis",
                    items: [{
                      type: "TextBlock",
                      size: "Large",
                      weight: "Bolder",
                      text: ("ðŸš€ " + $addin + " " + $version),
                      wrap: true
                    }]
                  },
                  {
                    type: "TextBlock",
                    text: "A new version is available for download.",
                    wrap: true,
                    spacing: "Medium"
                  },
                  {
                    type: "FactSet",
                    facts: [
                      { title: "Add-in:", value: $addin },
                      { title: "Version:", value: $version },
                      { title: "Released by:", value: $author }
                    ]
                  },
                  {
                    type: "TextBlock",
                    text: "**What'\''s New:**",
                    wrap: true,
                    spacing: "Medium"
                  },
                  {
                    type: "TextBlock",
                    text: $notes,
                    wrap: true,
                    size: "Small"
                  }
                ],
                actions: [{
                  type: "Action.OpenUrl",
                  title: "â¬‡ï¸ Go to Download Page",
                  url: "https://kamditis.github.io",
                  style: "positive"
                }]
              }
            }]
          }' > payload.json

          # Send to Teams
          HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" \
            -H "Content-Type: application/json" \
            -d @payload.json \
            "$WEBHOOK_URL")

          echo "Teams webhook responded with HTTP $HTTP_CODE"
          if [ "$HTTP_CODE" -lt 200 ] || [ "$HTTP_CODE" -ge 300 ]; then
            echo "::error::Teams webhook failed with HTTP $HTTP_CODE"
            exit 1
          fi
